# Complete Test Suite Example
# Demonstrates: Real-world test suite with all features
# Uses: yq (YAML processor) - a real CLI tool

name: "yq CLI Test Suite"
description: "Integration tests for yq YAML processor"

variables:
  VERSION_PATTERN: "[0-9]+\\.[0-9]+\\.[0-9]+"
  SAMPLE_YAML: |
    name: example
    version: 1.0.0
    settings:
      debug: true
      timeout: 30

fragments:
  successful-command:
    exitCode: 0
    timeout: 10

setupFile: |
  export TEST_DIR=$(mktemp -d)
  cat <<EOF > "$TEST_DIR/config.yaml"
  name: myapp
  version: 2.1.0
  database:
    host: localhost
    port: 5432
  features:
    - logging
    - metrics
  EOF

teardownFile: |
  rm -rf "$TEST_DIR"

tests:
  # Basic functionality
  - name: "Show help message"
    command: "yq --help"
    $ref: "#/fragments/successful-command"
    outputContains:
      - "yq"
      - "YAML"

  - name: "Show version in correct format"
    command: "yq --version"
    exitCode: 0
    outputMatches: "{{VERSION_PATTERN}}"

  # Error handling
  - name: "Reject invalid YAML file"
    command: |
      echo "invalid: yaml: content:" > "$TEST_DIR/bad.yaml"
      yq '.' "$TEST_DIR/bad.yaml"
    exitCode: 1

  - name: "Handle missing file gracefully"
    command: "yq '.' /nonexistent/file.yaml 2>&1 || true"
    exitCode: 0
    outputContains:
      - "no such file"

  # YAML operations
  - name: "Extract scalar value from YAML"
    command: "yq '.name' \"$TEST_DIR/config.yaml\""
    $ref: "#/fragments/successful-command"
    outputEquals: "myapp"

  - name: "Extract nested value"
    command: "yq '.database.port' \"$TEST_DIR/config.yaml\""
    exitCode: 0
    outputEquals: "5432"

  - name: "List array items"
    command: "yq '.features[]' \"$TEST_DIR/config.yaml\""
    exitCode: 0
    outputContains:
      - "logging"
      - "metrics"

  # Skipped tests
  - name: "Performance benchmark with large files"
    command: "yq '.' large-file.yaml"
    skip: "Benchmarking disabled in CI pipeline"
