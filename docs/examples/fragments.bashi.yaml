# Reusable Fragments Example
# Demonstrates: DRY principle with test fragments
# Uses: yq and standard Unix tools

name: "Reusable YAML Processing Fragments"

fragments:
  yaml-success:
    exitCode: 0
    timeout: 10

  valid-yaml-output:
    exitCode: 0
    outputContains:
      - ":"

setupFile: |
  export TEST_DIR=$(mktemp -d)
  cat <<EOF > "$TEST_DIR/app.yaml"
  name: webapp
  version: 1.0.0
  status: running
  EOF
  cat <<EOF > "$TEST_DIR/service.yaml"
  name: api-service
  version: 2.3.1
  status: healthy
  EOF

teardownFile: |
  rm -rf "$TEST_DIR"

tests:
  - name: "Read app config"
    command: "yq '.' \"$TEST_DIR/app.yaml\""
    $ref: "#/fragments/yaml-success"

  - name: "Read service config"
    command: "yq '.' \"$TEST_DIR/service.yaml\""
    $ref: "#/fragments/yaml-success"

  - name: "Extract app name"
    command: "yq '.name' \"$TEST_DIR/app.yaml\""
    $ref: "#/fragments/yaml-success"
    outputEquals: "webapp"

  - name: "Extract service status"
    command: "yq '.status' \"$TEST_DIR/service.yaml\""
    $ref: "#/fragments/yaml-success"
    outputEquals: "healthy"

