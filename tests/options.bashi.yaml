name: Options Test Suite
description: Test suite to verify command-line options handling. Uses bashi to test bashi.
# NOTE: These tests are using bashi to test bashi, which has a side-effect of capturing
# the output from bats rather than outputting to the terminal directly. Bats automatically
# switches to the tap formatter when its output is not a terminal, which affects the test by
# preventing the output from being tested as non-tap formatted. Therefore, all these tests
# assume --tap output formatting.

variables:
  bashi: $(pwd)/src/bashi
  matchTiming: "in [0-9]+ms"
  matchTapCount: 1\.\.[1-9][0-9]*

tests:
  - name: Version test
    command: "{{bashi}} --version"
    exitCode: 0
    outputContains:
      - "bashi version"

  - name: Help test
    command: "{{bashi}} --help"
    exitCode: 0
    outputContains:
      - "Usage:"
      - "OPTIONS"

  - name: Help without specifying help options
    command: "{{bashi}}"
    exitCode: 2
    outputContains:
      - "Usage:"
      - "OPTIONS"

  - name: Run hello bashi test
    command: "{{bashi}} ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Echo prints message"

  - name: Timings Option
    command: "{{bashi}} ./tests/hello.bashi.yaml --timing --no-color"
    exitCode: 0
    outputMatches: "{{matchTiming}}"

  - name: Short help option (-h)
    command: "{{bashi}} -h"
    exitCode: 0
    outputContains:
      - "Usage:"
      - "OPTIONS"
      - "--help"

  - name: Short version option (-v)
    command: "{{bashi}} -v"
    exitCode: 2
    outputContains:
      - "No test suite file specified"

  - name: Verbose option (--verbose)
    command: "{{bashi}} --verbose ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Validating YAML schema"
      - "Executing tests"

  - name: Validate-only option (--validate-only)
    command: "{{bashi}} --validate-only ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Schema validation passed"

  - name: Validate-only with invalid file
    command: "{{bashi}} --validate-only /nonexistent/file.yaml"
    exitCode: 2
    outputContains:
      - "File not found"

  - name: TAP format option (--tap)
    command: "{{bashi}} --tap ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "ok 1"
    outputMatches: "{{matchTapCount}}"

  - name: Short TAP format option (-t)
    command: "{{bashi}} -t ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains: "ok 1"
    outputMatches: "{{matchTapCount}}"

  - name: Timing option (short form -T)
    command: "{{bashi}} -T ./tests/hello.bashi.yaml --no-color"
    exitCode: 0
    outputMatches: "{{matchTiming}}"

  - name: Trace option (-x)
    command: "{{bashi}} -x ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Hello, Bashi"

  - name: Trace option (--trace)
    command: "{{bashi}} --trace ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Hello, Bashi"

  - name: Timeout option with default value
    command: "{{bashi}} --timeout 300 ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Echo prints message"

  - name: Timeout option with custom value
    command: "{{bashi}} --timeout 60 ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Echo prints message"

  - name: No-color option (--no-color)
    command: "{{bashi}} --no-color ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Echo prints message"

  - name: Multiple options combined
    command: "{{bashi}} --verbose --timing --no-color ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "Echo prints message"
    outputMatches: "{{matchTiming}}"

  - name: Multiple options with TAP format
    command: "{{bashi}} --tap --timing ./tests/hello.bashi.yaml"
    exitCode: 0
    outputContains:
      - "ok 1"
    outputMatches:
      - "{{matchTiming}}"
      - "{{matchTapCount}}"

  - name: Invalid option handling
    command: "{{bashi}} --invalid-option ./tests/hello.bashi.yaml"
    exitCode: 2
    outputContains:
      - "Unknown option"

  - name: Help takes precedence over other options
    command: "{{bashi}} --help --version"
    exitCode: 0
    outputContains:
      - "Usage:"
      - "OPTIONS"
